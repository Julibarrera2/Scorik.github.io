<!DOCTYPE html>
<html lang="en" x-data="creatorApp()">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Creator</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Alpine.js -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.2/dist/cdn.min.js" defer></script>

    <style>
        body {
            background: #ffffff;
            overflow-x: hidden;
            font-family: Arial, sans-serif;
        }

        /* TOP BAR */
        .topbar {
            width: 100%;
            height: 70px;
            background: #B573FF;
            display: flex;
            align-items: center;
            justify-content: center;
            position: fixed;
            top: 0;
            z-index: 20;
        }

        .hamburger {
            position: absolute;
            left: 20px;
            top: 12px;
            background: #8B35FF;
            border-radius: 8px;
            padding: 8px 12px;
        }

        .hamburger div {
            width: 28px;
            height: 4px;
            background: white;
            margin: 4px 0;
            border-radius: 5px;
        }

        .title {
            font-size: 28px;
            color: white;
            font-weight: bold;
        }

        /* SIDEBAR ORIGINAL */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 270px;
            height: 100vh;
            background: #6B2BD9;
            transform: translateX(-100%);
            transition: 0.25s;
            z-index: 30;
            padding-top: 90px;
        }

        .sidebar.open {
            transform: translateX(0);
        }

        .sidebar-btn {
            background: white;
            color: #8300F6;
            font-weight: bold;
            border: none;
            border-radius: 15px;
            width: 160px;
            padding: 8px 20px;
            margin: 15px auto;
            display: block;
        }

        /* LEFT TOOLBAR */
        .tool-column {
            position: fixed;
            top: 80px;
            left: 10px;
            width: 70px;
            background: #eaeaea;
            border-radius: 15px;
            padding: 10px;
        }

        .tool-btn {
            width: 55px;
            height: 55px;
            background: white;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            border: 2px solid #b370ff;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tool-btn img {
            width: 40px;
        }

        /* RIGHT PANEL */
        .right-panel {
            position: fixed;
            right: 0;
            top: 80px;
            width: 260px;
            background: #B573FF;
            padding: 15px;
            border-radius: 15px 0 0 15px;
            color: white;
        }

        .panel-block {
            background: #8B35FF;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 15px;
            cursor: pointer;
        }

        .panel-content {
            background: white;
            border-radius: 10px;
            padding: 8px;
            margin-top: 8px;
            display: none;
        }

        .panel-content.open {
            display: block;
        }

        .panel-content img {
            width: 100%;
            cursor: grab;
            margin: 4px 0;
        }

        /* MAIN STAFF */
        .canvas-area {
            margin-top: 100px;
            margin-left: 110px;
            margin-right: 300px;
        }

        #staffCanvas {
            width: 100%;
            border-radius: 10px;
        }

        /* DRAGGING ICONS */
        .draggable {
            position: absolute;
            width: 60px;
            cursor: grab;
        }
    </style>

</head>
<body>

    <!-- SIDEBAR -->
    <div class="sidebar" :class="{ 'open': sidebarOpen }">
        <button class="sidebar-btn" onclick="location.href='mp3tomusic.html'">mp3 to music sheet</button>
        <button class="sidebar-btn" onclick="location.href='library.html'">Library</button>
        <button class="sidebar-btn" onclick="location.href='create.html'">Create</button>
        <button class="sidebar-btn" onclick="location.href='User.html'">User</button>
    </div>

    <!-- TOPBAR -->
    <div class="topbar">
        <div class="hamburger" @click="sidebarOpen=!sidebarOpen">
            <div></div><div></div><div></div>
        </div>
        <div class="title">creator</div> 
    </div>

    <!-- LEFT TOOLBAR -->
    <div class="tool-column">
        <div class="tool-btn" @click="togglePanel('notas')">
            <img src="notas/negra.png">
        </div>
        <div class="tool-btn" @click="togglePanel('silencios')">
            <img src="silencios/silencio_negra.png">
        </div>
        <div class="tool-btn" @click="togglePanel('claves')">
            <img src="claves/sol.png">
        </div>
        <div class="tool-btn" @click="togglePanel('dinamica')">
            <img src="dinamica/dinamica.png">
        </div>
        <div class="tool-btn" @click="togglePanel('armadura')">
            <img src="armadura/armadura.png">
        </div>
        <div class="tool-btn" @click="togglePanel('compas')">
            <img src="compas/compas.png">
        </div>
    </div>

    <!-- RIGHT PANEL -->
    <div class="right-panel">

        <!-- NOTAS -->
        <div class="panel-block" @click="panel.notas=!panel.notas">
            Notas
            <div class="panel-content" :class="{ 'open': panel.notas }">
                <img src="notas/redonda.png" @mousedown="startDrag($event)">
                <img src="notas/blanca.png" @mousedown="startDrag($event)">
                <img src="notas/negra.png" @mousedown="startDrag($event)">
                <img src="notas/corchea.png" @mousedown="startDrag($event)">
            </div>
        </div>

        <!-- SILENCIOS -->
        <div class="panel-block" @click="panel.silencios=!panel.silencios">
            Silencios
            <div class="panel-content" :class="{ 'open': panel.silencios }">
                <img src="silencios/silencio_redonda.png" @mousedown="startDrag($event)">
                <img src="silencios/silencio_blanca.png" @mousedown="startDrag($event)">
                <img src="silencios/silencio_negra.png" @mousedown="startDrag($event)">
            </div>
        </div>

        <!-- CLAVES -->
        <div class="panel-block" @click="panel.claves=!panel.claves">
            Claves
            <div class="panel-content" :class="{ 'open': panel.claves }">
                <img src="claves/sol.png" @mousedown="startDrag($event)">
            </div>
        </div>

        <!-- DINÁMICA -->
        <div class="panel-block" @click="panel.dinamica=!panel.dinamica">
            Dinámica
            <div class="panel-content" :class="{ 'open': panel.dinamica }">
                <img src="dinamica/dinamica.png" @mousedown="startDrag($event)">
            </div>
        </div>

        <!-- ARMADURA -->
        <div class="panel-block" @click="panel.armadura=!panel.armadura">
            Armadura
            <div class="panel-content" :class="{ 'open': panel.armadura }">
                <img src="armadura/armadura.png" @mousedown="startDrag($event)">
            </div>
        </div>

        <!-- COMPÁS -->
        <div class="panel-block" @click="panel.compas=!panel.compas">
            Compás
            <div class="panel-content" :class="{ 'open': panel.compas }">
                <img src="compas/compas.png" @mousedown="startDrag($event)">
            </div>
        </div>

        <button class="btn btn-success w-100 mt-2" @click="saveCanvas()">Save</button>
    </div>

    <!-- MAIN CANVAS -->
    <div class="canvas-area">
        <canvas id="staffCanvas"></canvas>
    </div>

<script>
async function checkAuth() {
    try {
    const r = await fetch('/api/session');
    if (!r.ok) throw 0;
    const d = await r.json();
    if (!d.logged_in) throw 0;
    } catch {
    window.location.href = 'login.html';
    }
}
async function logout() {
    await fetch('/api/logout', { method: 'POST' });
    window.location.href = 'index.html';
}





//CREADOR 
function creatorApp() {
    return {
        sidebarOpen: false,

        panel: {
            notas: false,
            silencios: false,
            claves: false,
            dinamica: false,
            armadura: false,
            compas: false
        },

        dragging: null,
        xmlDoc: null,
        osmd: null,

        async init() {
            // Cargar XML vacío
            const blankXml = `
            <?xml version="1.0" encoding="UTF-8"?>
            <score-partwise version="3.1">
                <part-list>
                    <score-part id="P1"><part-name>Music</part-name></score-part>
                </part-list>
                <part id="P1">
                    <measure number="1">
                        <attributes>
                            <divisions>1</divisions>
                            <key><fifths>0</fifths></key>
                            <time><beats>4</beats><beat-type>4</beat-type></time>
                            <clef><sign>G</sign><line>2</line></clef>
                        </attributes>
                    </measure>
                </part>
            </score-partwise>`;

            const parser = new DOMParser();
            this.xmlDoc = parser.parseFromString(blankXml, "application/xml");

            this.osmd = new opensheetmusicdisplay.OpenSheetMusicDisplay("staffCanvas", {
                drawTitle: false,
                drawComposer: false,
                drawCredits: false
            });

            await this.osmd.load(blankXml);
            this.osmd.render();
        },

        togglePanel(name) {
            this.panel[name] = !this.panel[name];
        },

        startDrag(event) {
            const img = event.target;
            this.dragging = {
                img,
                offsetX: event.offsetX,
                offsetY: event.offsetY
            };

            document.addEventListener("mousemove", this.dragMove);
            document.addEventListener("mouseup", this.dragStop);
        },

        dragMove: (event) => {
            if (!creatorAppInstance.dragging) return;
        },

        dragStop: async (event) => {
            document.removeEventListener("mousemove", creatorAppInstance.dragMove);
            document.removeEventListener("mouseup", creatorAppInstance.dragStop);

            const x = event.clientX;
            const y = event.clientY;

            // Convert drop position → Nota en MusicXML
            creatorAppInstance.addNoteToXml("C", 4, "quarter");

            creatorAppInstance.dragging = null;

            // Volver a renderizar
            const xmlString = new XMLSerializer().serializeToString(creatorAppInstance.xmlDoc);
            await creatorAppInstance.osmd.load(xmlString);
            creatorAppInstance.osmd.render();
        },

        addNoteToXml(step, octave, type) {
            const note = this.xmlDoc.createElement("note");

            const pitch = this.xmlDoc.createElement("pitch");
            pitch.innerHTML = `<step>${step}</step><octave>${octave}</octave>`;
            note.appendChild(pitch);

            const duration = this.xmlDoc.createElement("duration");
            duration.textContent = "1";
            note.appendChild(duration);

            const typeEl = this.xmlDoc.createElement("type");
            typeEl.textContent = type;
            note.appendChild(typeEl);

            const measure = this.xmlDoc.querySelector("measure");
            measure.appendChild(note);
        },

        async saveCanvas() {
            const xml = new XMLSerializer().serializeToString(this.xmlDoc);

            const svg = document.querySelector("#staffCanvas svg");
            const serializer = new XMLSerializer();
            const svgString = serializer.serializeToString(svg);

            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");
            const img = new Image();
            img.src = URL.createObjectURL(new Blob([svgString], {type:"image/svg+xml"}));

            img.onload = async () => {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                const png = canvas.toDataURL("image/png");

                const nombre = prompt("Nombre de la partitura:");
                const usuario = JSON.parse(localStorage.getItem("currentUser")).email;

                await fetch("/api/editor/save", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({ usuario, nombre, xml, png })
                });

                window.location.href = "library.html";
            };
        }
    };
}

const creatorAppInstance = creatorApp();

</script>

    <!-- HTML2CANVAS for saving -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

</body>
</html>

